@using BlazorFurniture.Shared.Components.Table
@using BlazorFurniture.Shared.Extensions
@using BlazorFurniture.Shared.Models.Users.Responses
@using BlazorFurniture.Shared.Resources.Pages.Admin
@using BlazorFurniture.Shared.Services.API.Interfaces
@using BlazorFurniture.Shared.Services.Security.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Localization
@using Microsoft.Extensions.Logging
@using System.Net

<ContentWithHeader Title="@AdminResource.myGroups" Class="h-full" Style="@Style">
    <ChildContent>
        @if (Groups is null)
        {
            <ListLoadingComponent RowCount="7" />
        }
        else
        {
            <MudList T="UserGroupMembershipModel" Dense=true Gutters=true Class="overflow-y-scroll" Style="min-height:300px;">
                @foreach (var group in Groups)
                {
                    <MudDivider DividerType="DividerType.FullWidth" />
                    <MudListItem Href="@($"/admin/groups/{group.Id}")">
                        <AvatarContent>
                            <MudAvatar>
                                <MudImage Src="https://picsum.photos/200/300" />
                            </MudAvatar>
                        </AvatarContent>
                        <ChildContent>
                            <MudText Typo="Typo.h6">@group.Name</MudText>
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">@CommonResource.role: @CommonLocalizer[$"roles.{group.Role}"]</MudText>
                        </ChildContent>
                    </MudListItem>
                }
            </MudList>
        }
    </ChildContent>
</ContentWithHeader>

@code {
    [Inject] public required IStringLocalizer<CommonResource> CommonLocalizer { get; set; }
    [Inject] public required AuthenticationStateProvider AuthenticationStateProvider { get; set; }
    [Inject] public required IUsersClient UserApi { get; set; }

    [PersistentState]
    public IEnumerable<UserGroupMembershipModel>? Groups { get; set; }

    [Parameter] public string Style { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var userId = await RetrieveUserId();

        if (userId is not null)
        {
            await LoadGroups(userId.Value);
        }
    }

    private async Task<Guid?> RetrieveUserId()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated is false)
        {
            return null;
        }

        return user.GetUserId();
    }

    private async Task LoadGroups(Guid userId)
    {
        var response = await UserApi.GetUserGroups(userId, default);

        switch (response.StatusCode)
        {
            case HttpStatusCode.OK:
                Groups = response.Content!;
                break;
            default:
                break;
        }
    }
}
