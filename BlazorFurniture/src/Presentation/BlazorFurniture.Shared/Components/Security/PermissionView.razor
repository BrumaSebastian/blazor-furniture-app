@using BlazorFurniture.Shared.Services.Security.Interfaces
@implements IDisposable

@if (Allowed)
{
    @ChildContent
}
else
{
    @NotAuthorized
}

@code {
    [Inject]
    public required IPermissionsService PermissionsService { get; init; }

    [Parameter]
    public string? Require { get; set; }
    [Parameter]
    public IEnumerable<string> AnyOf { get; set; } = [];
    [Parameter]
    public IEnumerable<string> AllOf { get; set; } = [];
    [Parameter]
    public RenderFragment? ChildContent { get; set; }
    [Parameter]
    public RenderFragment? NotAuthorized { get; set; }

    [PersistentState]
    public bool Allowed { get; private set; }

    protected override async Task OnInitializedAsync()
    {
        PermissionsService.Changed += OnChanged;
        await RecomputeAsync();
    }

    private async Task RecomputeAsync()
    {
        if (AllOf.Any())
        {
            foreach (var permission in AllOf)
            {
                if (!await PermissionsService.HasPermission(permission))
                {
                    Allowed = false;
                    StateHasChanged();
                    return;
                }
            }

            Allowed = true;
        }
        else if (AnyOf.Any())
        {
            Allowed = false;

            foreach (var permission in AnyOf)
            {
                if (await PermissionsService.HasPermission(permission))
                {
                    Allowed = true;
                    break;
                }
            }
        }
        else if (!string.IsNullOrWhiteSpace(Require))
        {
            Allowed = await PermissionsService.HasPermission(Require!);
        }
        else
        {
            Allowed = true;
        }

        StateHasChanged();
    }

    private async void OnChanged()
    {
        await RecomputeAsync();
    }

    public void Dispose()
    {
        PermissionsService.Changed -= OnChanged;
    }
}