@page "/admin/groups/{groupId:guid}"
@using BlazorFurniture.Shared.Components.Table
@using BlazorFurniture.Shared.Extensions
@using BlazorFurniture.Client.Components.Admin.Dialogs
@layout AdminLayout
@inherits AdminPageBase
@attribute [Authorize]

<MudOverlay Visible="@(groupDetails is null)" DarkBackground="true"></MudOverlay>

@if (groupDetails is not null)
{
    <MudStack Row="true" AlignItems="AlignItems.Center">
        <MudStack>
            <MudText Typo="Typo.h4">@groupDetails.Name</MudText>
            <MudText Typo="Typo.subtitle1">@groupDetails.Description</MudText>
            <MudText Typo="Typo.subtitle2">@AdminResource.groups_groupSubtitle</MudText>
        </MudStack>
        <MudSpacer />
        <MudButton OnClick="AssignUserToGroupDialog" StartIcon="@Icons.Material.Filled.PersonAdd" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small">
            <MudText Typo="Typo.subtitle1">@AdminResource.add_member</MudText>
        </MudButton>
    </MudStack>
    <MudTabs Outlined="true" @bind-ActivePanelIndex="@tabIndex">
        <MudTabPanel Text="@AdminResource.groups_users" Icon="@Icons.Material.Filled.Groups" />
        <MudTabPanel Text="@AdminResource.groups_roles" />
    </MudTabs>
}

@if (tabIndex is 0)
{
    <MudTable T="GroupUserModel" @ref="usersTable" ServerData="GetUsers"
              Hover="true" OnRowClick="NavigateToUserEvent"
              RowClass="cursor-pointer" Breakpoint="Breakpoint.Sm"
              Context="tableContext">
        <ToolBarContent>
            <MudText Typo="Typo.h6">@AdminResource.nav_users</MudText>
            <MudSpacer />
            <MudTextField T="string" ValueChanged="@(async s => await OnSearch(s))" Placeholder="@CommonResource.search" Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Small" DebounceInterval="300" />
        </ToolBarContent>
        <HeaderContent>
            <MudTh>@CommonResource.model_name</MudTh>
            <MudTh>@CommonResource.email</MudTh>
            <MudTh>@CommonResource.role</MudTh>
            <MudTh>@CommonResource.actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="@CommonResource.model_name">@($"{tableContext.FirstName} {tableContext.LastName}")</MudTd>
            <MudTd DataLabel="@CommonResource.email">@tableContext.Email</MudTd>
            <MudTd DataLabel="@CommonResource.role">@CommonLocalizer[$"roles.{tableContext.Role}"]</MudTd>
            <MudTd DataLabel="@CommonResource.actions">
                <RoleAuthorizeView PlatformRole="@PlatformRoles.Admin" GroupRole="@GroupRoles.GroupAdmin" GroupId="@GroupId">
                    <Authorized>
                        @if (!context.User.GetUserId().Equals(tableContext.Id))
                        {
                            <MudMenu Icon="@Icons.Material.Filled.MoreHoriz"
                                     AriaLabel="Open user actions">
                                <PermissionAuthorizeView Permission="@Permissions.REMOVE_GROUP_MEMBER" GroupId="@GroupId">
                                    <Authorized>
                                        <MudMenuItem Label="Remove" OnClick="@(async () => await OpenRemoveMemberDialog(tableContext))" />
                                    </Authorized>
                                </PermissionAuthorizeView>
                            </MudMenu>
                        }
                    </Authorized>
                </RoleAuthorizeView>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>@CommonResource.message_noRecordsFound</MudText>
        </NoRecordsContent>
        <LoadingContentBody>
            <TableLoadingComponent ColumnCount="3" />
        </LoadingContentBody>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}

@if (tabIndex is 1)
{
    <MudTable T="GroupRoleModel" @ref="rolesTable" ServerData="GetRoles"
              Hover="true"
              RowClass="cursor-pointer"
              Breakpoint="Breakpoint.Sm">
        <ToolBarContent>
            <MudText Typo="Typo.h6">@AdminResource.groups_roles</MudText>
            <MudSpacer />
        </ToolBarContent>
        <HeaderContent>
            <MudTh>@CommonResource.role</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="@CommonResource.role">@CommonLocalizer[$"roles.{context.Role}"]</MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>@CommonResource.message_noRecordsFound</MudText>
        </NoRecordsContent>
        <LoadingContentBody>
            <TableLoadingComponent RowCount="10" />
        </LoadingContentBody>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}

@code {
    [Inject] public required IDialogService DialogService { get; init; }
    [Inject] public required IGroupsApi GroupsApi { get; init; }
    [Inject] public required NavigationManager NavigationManager { get; init; }
    [Inject] public required IStringLocalizer<CommonResource> CommonLocalizer { get; set; }
    [Inject] public required ISnackbar Snackbar { get; init; }

    [Parameter] public Guid GroupId { get; init; }

    private MudTable<GroupUserModel> usersTable = default!;
    private MudTable<GroupRoleModel> rolesTable = default!;
    private int tabIndex;
    private string? searchString;
    private DetailedGroupModel? groupDetails;

    protected override async Task OnInitializedAsync()
    {
        var response = await GroupsApi.Get(GroupId, default);

        switch (response.StatusCode)
        {
            case HttpStatusCode.OK:
                groupDetails = response.Content!;
                break;
            default:
                Snackbar.Add(CommonResource.errors_unknownError, MudBlazor.Severity.Error);
                break;
        }
    }

    private async Task<TableData<GroupUserModel>> GetUsers(TableState state, CancellationToken token)
    {
        var response = await GroupsApi.GetUsers(GroupId, state.Page, state.PageSize, searchString, token);

        switch (response.StatusCode)
        {
            case HttpStatusCode.OK:
                return new TableData<GroupUserModel>()
                {
                    TotalItems = response.Content!.Total,
                    Items = response.Content!.Results
                };
            default:
                Snackbar.Add(CommonResource.errors_unknownError, MudBlazor.Severity.Error);
                break;
        }

        return new();
    }

    private async Task<TableData<GroupRoleModel>> GetRoles(TableState state, CancellationToken token)
    {
        return new()
        {
            Items = groupDetails?.Roles ?? Array.Empty<GroupRoleModel>(),
            TotalItems = groupDetails?.Roles?.Count() ?? 0
        };
    }

    private void NavigateToUserEvent(TableRowClickEventArgs<GroupUserModel> e)
    {
        var href = $"/admin/groups/{GroupId}/users/{e.Item!.Id}";
        Breadcrumbs.Add(new BreadcrumbItem(e.Item!.Email, href: href));
        NavigationManager.NavigateTo(href);
    }

    private async Task OnSearch(string text)
    {
        searchString = text;
        await usersTable.ReloadServerData();
    }

    private async Task AssignUserToGroupDialog()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Large,
        };
        var parameters = new DialogParameters<AssignUserToGroupDialog>
        {
            { x => x.Group, groupDetails }
        };
        var dialogRef = await DialogService.ShowAsync<AssignUserToGroupDialog>($"Assign user to {groupDetails!.Name}", parameters, options);
        var result = await dialogRef.Result;

        if (result?.Data is bool updated && updated)
        {
            await usersTable.ReloadServerData();
        }
    }

    private async Task OpenRemoveMemberDialog(GroupUserModel user)
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = false,
            BackdropClick = false,
            MaxWidth = MaxWidth.Small,
        };
        var parameters = new DialogParameters<RemoveMemberFromGroupDialog>
        {
            { x => x.Group, groupDetails },
            { x => x.User, user }
        };
        var dialogRef = await DialogService.ShowAsync<RemoveMemberFromGroupDialog>($"Remove {user.FullName}?", parameters, options);
        var result = await dialogRef.Result;
        if (result?.Data is not null)
        {
            await usersTable.ReloadServerData();
        }
    }
}
