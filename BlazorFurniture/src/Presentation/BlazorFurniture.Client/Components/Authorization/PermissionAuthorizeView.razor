@using BlazorFurniture.Shared.Services.Security.Interfaces
@using Microsoft.AspNetCore.Components.Authorization

@if (hasPermission)
{
    @Authorized
}
else
{
    @NotAuthorized
}

@code {
    [Inject] public required IPermissionsService PermissionService { get; init; }
    [Inject] public required AuthenticationStateProvider AuthStateProvider { get; init; }

    [Parameter, EditorRequired] public string Permission { get; set; } = string.Empty;
    [Parameter] public Guid? GroupId { get; set; }
    [Parameter] public RenderFragment? Authorized { get; set; }
    [Parameter] public RenderFragment? NotAuthorized { get; set; }

    private bool hasPermission;

    protected override async Task OnParametersSetAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();

        if (!authState.User.Identity?.IsAuthenticated ?? true)
        {
            hasPermission = false;
            return;
        }

        hasPermission = GroupId.HasValue
            ? await PermissionService.HasGroupPermission(Permission, GroupId.Value)
            : await PermissionService.HasPermission(Permission);
    }
}