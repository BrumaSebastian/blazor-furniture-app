@inject IThemeService ThemeService
@inject ISearchService SearchService
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IDisposable

<MudThemeProvider Theme="@theme" IsDarkMode="isDarkMode" />

<MudIconButton Icon="@Icons.Material.Filled.Menu"
               Color="Color.Inherit"
               Edge="Edge.Start"
               OnClick="@DrawerToggle" />
<MudText Typo="Typo.h6">@CommonResource.message_welcome, @CurrentUser?.FullName</MudText>

<MudSpacer />

<MudContainer Class="d-flex align-center gap-2" MaxWidth="MaxWidth.Small">
    <MudTextField Class="flex-grow-1" @bind-Value=@SearchService.SearchTerm Label="@CommonResource.search" Immediate=true DebounceInterval="300" Variant="Variant.Text" Margin="Margin.Dense" FullWidth=false></MudTextField>
    <MudBadge Content="2" Color="Color.Primary" Overlap=true>
        <MudIconButton Icon="@Icons.Material.Filled.CircleNotifications" Color="Color.Default" />
    </MudBadge>
    <MudIconButton Icon="@(DarkLightModeButtonIcon)" Color="Color.Inherit" OnClick="@DarkModeToggle" />
    <CultureSelector />
    <UserMenu User="@CurrentUser" />
</MudContainer>

@code {
    [CascadingParameter(Name = "CurrentUser")] public UserProfileModel? CurrentUser { get; set; }
    [Parameter, EditorRequired] public bool IsDrawerOpen { get; set; }
    [Parameter, EditorRequired] public EventCallback<bool> IsDrawerOpenChanged { get; set; }

    private MudTheme? theme;
    private bool isDarkMode = false;

    protected override async Task OnInitializedAsync()
    {
        theme = ThemeService.GetTheme(ThemeType.Admin);
        isDarkMode = ThemeService.IsDarkMode;
        ThemeService.OnThemeChanged += OnThemeChanged;
    }

    private string DarkLightModeButtonIcon => isDarkMode switch
    {
        true => Icons.Material.Rounded.AutoMode,
        false => Icons.Material.Outlined.DarkMode,
    };

    private async Task DrawerToggle()
    {
        IsDrawerOpen = !IsDrawerOpen;

        if (IsDrawerOpenChanged.HasDelegate)
        {
            await IsDrawerOpenChanged.InvokeAsync(IsDrawerOpen);
        }
    }
    private void DarkModeToggle() => ThemeService.ToggleDarkMode();

    private void OnThemeChanged()
    {
        isDarkMode = ThemeService.IsDarkMode;
        StateHasChanged();
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }
}