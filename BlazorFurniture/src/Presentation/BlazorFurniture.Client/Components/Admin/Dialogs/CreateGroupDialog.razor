@using System.Net
@using BlazorFurniture.Shared.Models.Groups
@using BlazorFurniture.Shared.Resources.Pages.Admin
@using BlazorFurniture.Shared.Services.API
@using BlazorFurniture.Shared.Services.API.Interfaces
@using BlazorFurniture.Shared.Validators;
@using BlazorFurniture.Shared.Validators.Groups
@using FluentValidation
@implements IDisposable

<MudDialog>
	<TitleContent>
        <MudText Typo="Typo.subtitle1" GutterBottom="true">@AdminResource.add_group</MudText>
	</TitleContent>
	<DialogContent>
        <MudForm Model="@model" @ref="@form" Validation="@(createGroupValidator.AsPropertyValidator())">
            <MudCardContent>
                <MudTextField @bind-Value="model.Name"
                              For="@(() => model.Name)"
                              Immediate="true"
                              Required="true"
                              Label="@CommonResource.model_name" />

                <MudTextField @bind-Value="model.Description"
                              For="@(() => model.Description)"
                              Immediate="true"
                              Label="@CommonResource.model_description" />
            </MudCardContent>
        </MudForm>
	</DialogContent>
	<DialogActions>
        <MudButton Disabled="@submitting" OnClick="Cancel">@CommonResource.button_cancel</MudButton>
        <MudButton Disabled="@submitting" Color="Color.Primary" ButtonType=ButtonType.Submit OnClick="@(async () => await Submit())">@CommonResource.button_submit</MudButton>
	</DialogActions>
</MudDialog>

@code {
    [Inject] public required IDialogService DialogService { get; init; }
    [Inject] public required ISnackbar Snackbar { get; init; }
    [Inject] public required IGroupsApi GroupsApi { get; init; }

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; init; } = default!;

    private MudForm form = null!; 
    private bool submitting = false;
    private readonly CreateGroupModel model = new();
    private readonly CreateGroupModelValidator createGroupValidator = new();
    private readonly CancellationTokenSource cancellationTokenSource = new();

    private async Task Submit()
    {
        await form.Validate();

        if (!form.IsValid) return;

        submitting = true;
        var response = await GroupsApi.Create(model, cancellationTokenSource.Token);

        switch (response.StatusCode)
        {
            case HttpStatusCode.Created:
                Snackbar.Add(CommonResource.message_createdSuccessfully, MudBlazor.Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
                break;
            case HttpStatusCode.Conflict:
                Snackbar.Add(CommonResource.errors_conflictError, MudBlazor.Severity.Error);
                break;
            default:
                Snackbar.Add(CommonResource.errors_unknownError, MudBlazor.Severity.Error);
                break;
        }

        submitting = false;
    }

    private void Cancel()
    {
        cancellationTokenSource.Cancel();
        MudDialog.Cancel();
    }

    public void Dispose()
    {
        cancellationTokenSource.Cancel();
        cancellationTokenSource.Dispose();
    }
}
