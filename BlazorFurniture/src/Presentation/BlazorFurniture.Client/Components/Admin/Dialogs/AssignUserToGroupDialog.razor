@using BlazorFurniture.Shared.Components.Table
@using BlazorFurniture.Shared.Models.Groups
@using BlazorFurniture.Shared.Services.API.Interfaces

<MudDialog Gutters="true" OnBackdropClick="Cancel">
    <TitleContent>
        <MudText Typo="Typo.subtitle1" GutterBottom="true">Add Member to @Group.Name </MudText>
        <MudText Typo="Typo.subtitle2">Search for an existing user and assign them to the group.</MudText>
    </TitleContent>
    <DialogContent>
        <MudTable T="UserModel" @ref="usersTable" ServerData="GetUsers"
                  Hover="true" RowClass="cursor-pointer" Breakpoint="Breakpoint.Sm" Bordered="false" Dense="true">
            <ToolBarContent>
                <MudTextField T="string" ValueChanged="@(async s => await OnSearch(s))" Placeholder="@CommonResource.search" Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Small" DebounceInterval="300" />
            </ToolBarContent>
            <HeaderContent>
            </HeaderContent>
            <RowTemplate>
                <MudStack Row="true" Breakpoint="Breakpoint.Md" Class="my-2">
                    <MudStack>
                        <MudText Typo="Typo.subtitle1">
                            @($"{context.FirstName} {context.LastName}")
                        </MudText>
                        <MudText Typo="Typo.caption">
                            @context.Email
                        </MudText>
                    </MudStack>
                    <MudFlexBreak />
                    @if (context.Groups.Contains(Group.Id))
                    {
                        <MudButton Ripple="false" StartIcon="@Icons.Material.Filled.Check" Color="Color.Info" Variant="Variant.Filled" FullWidth="true">Added</MudButton>
                    }
                    else
                    {
                        <MudButton OnClick="@(async () => await AssignUserToGroup(context.Id))" StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary" Variant="Variant.Filled" FullWidth="true">Add</MudButton>
                    }
                </MudStack>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>@CommonResource.message_noRecordsFound</MudText>
            </NoRecordsContent>
            <LoadingContentBody>
                <TableLoadingComponent ColumnCount="1" />
            </LoadingContentBody>
            <PagerContent>
                <MudTablePager HideRowsPerPage="true" />
            </PagerContent>
        </MudTable>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@CommonResource.button_cancel</MudButton>
    </DialogActions>
</MudDialog>
@code {
    [Inject] public required ISnackbar Snackbar { get; init; }
    [Inject] public required IUsersApi UsersApi { get; init; }
    [Inject] public required IGroupsApi GroupsApi { get; init; }

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; init; } = default!;

    [Parameter, EditorRequired] public required GroupModel Group { get; set; }

    private MudTable<UserModel> usersTable = default!;
    private string? searchString;
    private bool groupMembersChanged = false;

    private async Task<TableData<UserModel>> GetUsers(TableState state, CancellationToken token)
    {
        var response = await UsersApi.GetUsers(state.Page, state.PageSize, searchString, token);

        switch (response.StatusCode)
        {
            case HttpStatusCode.OK:
                return new TableData<UserModel>()
                {
                    TotalItems = response.Content!.Total,
                    Items = response.Content!.Results
                };
            default:
                break;
        }

        return new();
    }

    private async Task OnSearch(string text)
    {
        searchString = text;
        await usersTable.ReloadServerData();
    }

    private void Cancel()
    {
        if (groupMembersChanged)
        {
            MudDialog.Close(DialogResult.Ok(true));
        }
        else{
            MudDialog.Cancel();
        }
    }

    private async Task AssignUserToGroup(Guid userId)
    {
        var response = await GroupsApi.AddMember(Group.Id, userId, default);

        switch (response.StatusCode)
        {
            case HttpStatusCode.NoContent:
                Snackbar.Add(CommonResource.message_groupMemberAdded, Severity.Success);
                await usersTable.ReloadServerData();
                groupMembersChanged = true;
                break;
            default:
                Snackbar.Add(CommonResource.errors_unknownError, Severity.Error);
                break;
        }
    }
}
