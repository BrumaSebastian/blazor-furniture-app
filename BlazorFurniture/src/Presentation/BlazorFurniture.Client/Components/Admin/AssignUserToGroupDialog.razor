@using BlazorFurniture.Shared.Components.Table
@using BlazorFurniture.Shared.Models.Groups
@using BlazorFurniture.Shared.Services.API.Interfaces

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.subtitle1" GutterBottom="true">Add Member to @Group.Name </MudText>
        <MudText Typo="Typo.subtitle2">Search for an existing user and assign them to a role.</MudText>
    </TitleContent>
    <DialogContent>
        <MudTable T="GroupUserModel" @ref="usersTable" ServerData="GetUsers"
                  Hover="true" RowClass="cursor-pointer" Breakpoint="Breakpoint.Sm" Bordered="false" Dense="true">
            <ToolBarContent>
                <MudTextField T="string" ValueChanged="@(async s => await OnSearch(s))" Placeholder="@CommonResource.search" Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Small" DebounceInterval="300" />
            </ToolBarContent>
            <HeaderContent>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="@CommonResource.model_name">
                    <MudStack Row="true">
                        <MudStack>
                            <MudText Typo="Typo.subtitle1">
                                @($"{context.FirstName} {context.LastName}")
                            </MudText>
                            <MudText Typo="Typo.caption">
                                @context.Email
                            </MudText>
                        </MudStack>
                        <MudSpacer />
                        <MudButton Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small">Add</MudButton>
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>@CommonResource.message_noRecordsFound</MudText>
            </NoRecordsContent>
            <LoadingContentBody>
                <TableLoadingComponent ColumnCount="1" />
            </LoadingContentBody>
            <PagerContent>
                <MudTablePager HideRowsPerPage="true" />
            </PagerContent>
        </MudTable>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@CommonResource.button_cancel</MudButton>
    </DialogActions>
</MudDialog>
@code {
    [Inject] public required IDialogService DialogService { get; init; }
    [Inject] public required ISnackbar Snackbar { get; init; }
    [Inject] public required IGroupsApi GroupsApi { get; init; }

    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; init; } = default!;

    [Parameter, EditorRequired] public required GroupModel Group { get; set; }

    private MudTable<GroupUserModel> usersTable = default!;
    private string? searchString;

    private async Task<TableData<GroupUserModel>> GetUsers(TableState state, CancellationToken token)
    {
        var response = await GroupsApi.GetUsers(Group.Id, state.Page, state.PageSize, searchString, token);

        switch (response.StatusCode)
        {
            case HttpStatusCode.OK:
                return new TableData<GroupUserModel>()
                {
                    TotalItems = response.Content!.Total,
                    Items = response.Content!.Results
                };
            default:
                // Snackbar.Add(CommonResource.errors_unknownError, MudBlazor.Severity.Error);
                break;
        }

        return new();
    }

    private async Task OnSearch(string text)
    {
        searchString = text;
        await usersTable.ReloadServerData();
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
